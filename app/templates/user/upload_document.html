{% extends "base.html" %}

{% block title %}점검서 업로드{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-cloud-upload"></i> 점검서 업로드</h2>
        <p class="text-muted">담당 고객사의 점검서 PDF 파일을 업로드할 수 있습니다.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('upload_document') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">고객사 선택 <span class="text-danger">*</span></label>
                        <select class="form-select" id="customer_id" name="customer_id" required>
                            <option value="">고객사를 선택하세요</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}" {% if request.form.get('customer_id') == customer.id|string %}selected{% endif %}>
                                {{ customer.name }} 
                                {% if customer.inspection_cycle_type %}
                                ({{ customer.inspection_cycle_type }})
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            담당 고객사만 표시됩니다.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="inspection_target_id" class="form-label">점검 대상 <span class="text-danger">*</span></label>
                        <select class="form-select" id="inspection_target_id" name="inspection_target_id" required disabled>
                            <option value="">고객사를 먼저 선택하세요</option>
                        </select>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            선택한 고객사의 점검 대상만 표시됩니다.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="inspection_type" class="form-label">점검 방식 <span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="inspection_type" id="visit" value="방문" required>
                            <label class="btn btn-outline-primary" for="visit">
                                <i class="bi bi-person-walking"></i> 방문 점검
                            </label>
                            
                            <input type="radio" class="btn-check" name="inspection_type" id="remote" value="원격" required>
                            <label class="btn btn-outline-primary" for="remote">
                                <i class="bi bi-laptop"></i> 원격 점검
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="file" class="form-label">점검서 파일 (PDF) <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="file" name="file"
                               accept=".pdf" required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            PDF 파일만 업로드 가능합니다 (최대 16MB)
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-exclamation-circle"></i>
                        <strong>안내:</strong> 
                        <ul class="mb-0 mt-2">
                            <li>점검서 파일명은 자동으로 생성됩니다 (예: 12월_고객사명_점검내역서)</li>
                            <li>점검 대상별로 업로드해야 완료로 집계됩니다</li>
                            <li>업로드한 점검서는 "고객사 관리 > 점검서보기"에서 확인할 수 있습니다</li>
                        </ul>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-cloud-upload"></i> 업로드
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> 취소
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
const targetMap = {{ target_map|tojson }};
const customerSelect = document.getElementById('customer_id');
const targetSelect = document.getElementById('inspection_target_id');
const initialCustomerId = "{{ request.form.get('customer_id', '') }}";
const initialTargetId = "{{ request.form.get('inspection_target_id', '') }}";

function populateTargets(customerId, preselectId = '') {
    targetSelect.innerHTML = '';

    const targets = targetMap[customerId] || [];
    if (!customerId || targets.length === 0) {
        targetSelect.disabled = true;
        const option = document.createElement('option');
        option.value = '';
        option.textContent = targets.length === 0 && customerId ? '등록된 점검 대상이 없습니다' : '고객사를 먼저 선택하세요';
        targetSelect.appendChild(option);
        return;
    }

    targetSelect.disabled = false;
    targetSelect.appendChild(new Option('점검 대상을 선택하세요', ''));
    targets.forEach(target => {
        const label = target.product ? `${target.name} (${target.product})` : target.name;
        const option = new Option(label, target.id);
        if (preselectId && String(preselectId) === String(target.id)) {
            option.selected = true;
        }
        targetSelect.appendChild(option);
    });
}

customerSelect.addEventListener('change', () => {
    populateTargets(customerSelect.value);
});

// 초기 값 복원
if (initialCustomerId) {
    customerSelect.value = initialCustomerId;
    populateTargets(initialCustomerId, initialTargetId);
}
</script>
{% endblock %}
