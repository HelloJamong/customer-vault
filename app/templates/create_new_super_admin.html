{% extends "base.html" %}

{% block title %}새 슈퍼관리자 생성{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-7">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>중요:</strong> 기본 관리자 계정(admin)으로 로그인하셨습니다.<br>
            보안을 위해 새로운 슈퍼관리자 계정을 생성해야 합니다. 계정 생성 후 기본 admin 계정은 자동으로 비활성화됩니다.
        </div>

        <div class="card shadow">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0"><i class="bi bi-person-badge"></i> 새 슈퍼관리자 계정 생성</h4>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>계정 생성 요구사항:</strong>
                    <ul class="mb-0 mt-2">
                        <li>계정 ID로 "admin"은 사용할 수 없습니다</li>
                        <li>패스워드는 <strong>최소 8자 이상</strong>이어야 합니다</li>
                        <li>패스워드에 <strong>대문자, 숫자, 특수문자</strong>가 모두 포함되어야 합니다</li>
                    </ul>
                </div>

                <form method="POST" action="{{ url_for('create_new_super_admin') }}" id="createSuperAdminForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">계정 ID <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" name="username" required autofocus
                               pattern="^(?!admin$).*" title="계정 ID로 'admin'은 사용할 수 없습니다">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 영문, 숫자, 특수문자 사용 가능 (단, "admin"은 사용 불가)
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label">이름 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 실명 또는 표시될 이름
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="email" class="form-label">이메일 (선택)</label>
                        <input type="email" class="form-control" id="email" name="email">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 선택사항입니다
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="mb-3">
                        <label for="password" class="form-label">패스워드 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="password" name="password" required>
                        <div class="form-text">
                            <i class="bi bi-shield-check"></i> <strong>보안 요구사항:</strong>
                            <ul class="mb-0 mt-1">
                                <li id="pwd-length" class="text-muted">최소 8자 이상</li>
                                <li id="pwd-uppercase" class="text-muted">대문자 포함</li>
                                <li id="pwd-number" class="text-muted">숫자 포함</li>
                                <li id="pwd-special" class="text-muted">특수문자 포함 (!@#$%^&*(),.?":{}|<>)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">패스워드 확인 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        <div id="password-match-feedback" class="form-text"></div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-danger btn-lg" id="submitBtn">
                            <i class="bi bi-person-plus-fill"></i> 슈퍼관리자 계정 생성
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="text-center mt-3 text-muted">
            <small><i class="bi bi-shield-lock"></i> 이 계정은 시스템의 모든 권한을 가집니다. 신중하게 생성하세요.</small>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 패스워드 실시간 검증
document.getElementById('password').addEventListener('input', function() {
    var password = this.value;

    // 길이 검증
    var lengthCheck = password.length >= 8;
    updateRequirement('pwd-length', lengthCheck);

    // 대문자 검증
    var uppercaseCheck = /[A-Z]/.test(password);
    updateRequirement('pwd-uppercase', uppercaseCheck);

    // 숫자 검증
    var numberCheck = /\d/.test(password);
    updateRequirement('pwd-number', numberCheck);

    // 특수문자 검증
    var specialCheck = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    updateRequirement('pwd-special', specialCheck);

    // 전체 검증 상태
    var allValid = lengthCheck && uppercaseCheck && numberCheck && specialCheck;

    // 제출 버튼 활성화/비활성화
    var confirmPassword = document.getElementById('confirm_password').value;
    var submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = !(allValid && password === confirmPassword && confirmPassword);
});

// 패스워드 확인 검증
document.getElementById('confirm_password').addEventListener('input', function() {
    var password = document.getElementById('password').value;
    var confirmPassword = this.value;
    var feedback = document.getElementById('password-match-feedback');

    if (confirmPassword) {
        if (password === confirmPassword) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
            feedback.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> 패스워드가 일치합니다</span>';
            this.setCustomValidity('');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
            feedback.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> 패스워드가 일치하지 않습니다</span>';
            this.setCustomValidity('패스워드가 일치하지 않습니다');
        }
    } else {
        this.classList.remove('is-valid', 'is-invalid');
        feedback.innerHTML = '';
        this.setCustomValidity('');
    }

    // 제출 버튼 업데이트
    updateSubmitButton();
});

// 요구사항 표시 업데이트
function updateRequirement(id, valid) {
    var element = document.getElementById(id);
    if (valid) {
        element.classList.remove('text-muted', 'text-danger');
        element.classList.add('text-success');
        element.innerHTML = element.innerHTML.replace(/^.*?(?=최소|대문자|숫자|특수문자)/, '<i class="bi bi-check-circle-fill"></i> ');
    } else {
        element.classList.remove('text-success');
        element.classList.add('text-muted');
        element.innerHTML = element.innerHTML.replace(/<i.*?<\/i>\s*/, '');
    }
}

// 제출 버튼 상태 업데이트
function updateSubmitButton() {
    var password = document.getElementById('password').value;
    var confirmPassword = document.getElementById('confirm_password').value;
    var submitBtn = document.getElementById('submitBtn');

    var lengthCheck = password.length >= 8;
    var uppercaseCheck = /[A-Z]/.test(password);
    var numberCheck = /\d/.test(password);
    var specialCheck = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    var allValid = lengthCheck && uppercaseCheck && numberCheck && specialCheck;
    var passwordsMatch = password === confirmPassword && confirmPassword;

    submitBtn.disabled = !(allValid && passwordsMatch);
}

// 계정 ID 검증 (admin 사용 불가)
document.getElementById('username').addEventListener('input', function() {
    var username = this.value.toLowerCase();
    if (username === 'admin') {
        this.classList.add('is-invalid');
        this.setCustomValidity('계정 ID로 "admin"은 사용할 수 없습니다');
    } else {
        this.classList.remove('is-invalid');
        this.setCustomValidity('');
    }
});

// 폼 제출 전 최종 검증
document.getElementById('createSuperAdminForm').addEventListener('submit', function(e) {
    var username = document.getElementById('username').value;
    var password = document.getElementById('password').value;
    var confirmPassword = document.getElementById('confirm_password').value;

    // admin 체크
    if (username.toLowerCase() === 'admin') {
        e.preventDefault();
        alert('계정 ID로 "admin"은 사용할 수 없습니다.');
        return false;
    }

    // 패스워드 일치 확인
    if (password !== confirmPassword) {
        e.preventDefault();
        alert('패스워드가 일치하지 않습니다.');
        return false;
    }

    // 패스워드 복잡성 확인
    if (password.length < 8 || !/[A-Z]/.test(password) || !/\d/.test(password) || !/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
        e.preventDefault();
        alert('패스워드가 보안 요구사항을 충족하지 않습니다.');
        return false;
    }

    return confirm('새로운 슈퍼관리자 계정을 생성하시겠습니까?\n\n생성 후 기본 admin 계정은 비활성화됩니다.');
});

// 초기 상태 설정
document.getElementById('submitBtn').disabled = true;
</script>
{% endblock %}
