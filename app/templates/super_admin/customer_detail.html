{% extends "base.html" %}

{% block title %}고객사 세부 정보 - {{ customer.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-building-fill"></i> 고객사 세부 정보</h2>
        <p class="text-muted">고객사의 상세 정보를 관리합니다.</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('manage_customers') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>
</div>

<form method="POST" action="{{ url_for('update_customer', customer_id=customer.id) }}">
    <!-- 고객사 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> 고객사 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">회사명 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="name" value="{{ customer.name }}" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">위치</label>
                    <input type="text" class="form-control" name="location" value="{{ customer.location or '' }}" placeholder="예: 서울시 강남구">
                </div>
            </div>
        </div>
    </div>

    <!-- 고객사 담당자 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-person-circle"></i> 고객사 담당자 정보</h5>
        </div>
        <div class="card-body">
            <!-- 정 담당자 -->
            <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person-fill"></i> 정 담당자</h6>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-control" name="contact_name" value="{{ customer.contact_name or '' }}" placeholder="담당자 이름">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">직급</label>
                    <input type="text" class="form-control" name="contact_position" value="{{ customer.contact_position or '' }}" placeholder="예: 부장">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">소속</label>
                    <input type="text" class="form-control" name="contact_department" value="{{ customer.contact_department or '' }}" placeholder="예: IT팀">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">연락처 (휴대전화)</label>
                    <input type="text" class="form-control" name="contact_mobile" value="{{ customer.contact_mobile or '' }}" placeholder="010-0000-0000">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">연락처 (내선)</label>
                    <input type="text" class="form-control" name="contact_phone" value="{{ customer.contact_phone or '' }}" placeholder="예: 1234">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">이메일</label>
                    <input type="email" class="form-control" name="contact_email" value="{{ customer.contact_email or '' }}" placeholder="example@company.com">
                </div>
            </div>

            <!-- 부담당자 추가 버튼 -->
            <div class="text-center my-3" id="addSubContactBtnContainer">
                <button type="button" class="btn btn-outline-success" id="addSubContactBtn">
                    <i class="bi bi-plus-circle"></i> 부 담당자 추가
                </button>
            </div>

            <!-- 부담당자 컨테이너 -->
            <div id="subContactsContainer">
                <!-- 부담당자 1 -->
                <div class="sub-contact-section" id="subContact1" style="display: none;">
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-person"></i> 부 담당자 1</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubContact(1)">
                            <i class="bi bi-x-circle"></i> 제거
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이름</label>
                            <input type="text" class="form-control" name="contact_name_sub1" value="{{ customer.contact_name_sub1 or '' }}" placeholder="담당자 이름">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">직급</label>
                            <input type="text" class="form-control" name="contact_position_sub1" value="{{ customer.contact_position_sub1 or '' }}" placeholder="예: 과장">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">소속</label>
                            <input type="text" class="form-control" name="contact_department_sub1" value="{{ customer.contact_department_sub1 or '' }}" placeholder="예: IT팀">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (휴대전화)</label>
                            <input type="text" class="form-control" name="contact_mobile_sub1" value="{{ customer.contact_mobile_sub1 or '' }}" placeholder="010-0000-0000">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (내선)</label>
                            <input type="text" class="form-control" name="contact_phone_sub1" value="{{ customer.contact_phone_sub1 or '' }}" placeholder="예: 1234">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이메일</label>
                            <input type="email" class="form-control" name="contact_email_sub1" value="{{ customer.contact_email_sub1 or '' }}" placeholder="example@company.com">
                        </div>
                    </div>
                </div>

                <!-- 부담당자 2 -->
                <div class="sub-contact-section" id="subContact2" style="display: none;">
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-person"></i> 부 담당자 2</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubContact(2)">
                            <i class="bi bi-x-circle"></i> 제거
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이름</label>
                            <input type="text" class="form-control" name="contact_name_sub2" value="{{ customer.contact_name_sub2 or '' }}" placeholder="담당자 이름">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">직급</label>
                            <input type="text" class="form-control" name="contact_position_sub2" value="{{ customer.contact_position_sub2 or '' }}" placeholder="예: 대리">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">소속</label>
                            <input type="text" class="form-control" name="contact_department_sub2" value="{{ customer.contact_department_sub2 or '' }}" placeholder="예: IT팀">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (휴대전화)</label>
                            <input type="text" class="form-control" name="contact_mobile_sub2" value="{{ customer.contact_mobile_sub2 or '' }}" placeholder="010-0000-0000">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (내선)</label>
                            <input type="text" class="form-control" name="contact_phone_sub2" value="{{ customer.contact_phone_sub2 or '' }}" placeholder="예: 1234">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이메일</label>
                            <input type="email" class="form-control" name="contact_email_sub2" value="{{ customer.contact_email_sub2 or '' }}" placeholder="example@company.com">
                        </div>
                    </div>
                </div>

                <!-- 부담당자 3 -->
                <div class="sub-contact-section" id="subContact3" style="display: none;">
                    <hr class="my-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="fw-bold text-secondary mb-0"><i class="bi bi-person"></i> 부 담당자 3</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSubContact(3)">
                            <i class="bi bi-x-circle"></i> 제거
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이름</label>
                            <input type="text" class="form-control" name="contact_name_sub3" value="{{ customer.contact_name_sub3 or '' }}" placeholder="담당자 이름">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">직급</label>
                            <input type="text" class="form-control" name="contact_position_sub3" value="{{ customer.contact_position_sub3 or '' }}" placeholder="예: 사원">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">소속</label>
                            <input type="text" class="form-control" name="contact_department_sub3" value="{{ customer.contact_department_sub3 or '' }}" placeholder="예: IT팀">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (휴대전화)</label>
                            <input type="text" class="form-control" name="contact_mobile_sub3" value="{{ customer.contact_mobile_sub3 or '' }}" placeholder="010-0000-0000">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">연락처 (내선)</label>
                            <input type="text" class="form-control" name="contact_phone_sub3" value="{{ customer.contact_phone_sub3 or '' }}" placeholder="예: 1234">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">이메일</label>
                            <input type="email" class="form-control" name="contact_email_sub3" value="{{ customer.contact_email_sub3 or '' }}" placeholder="example@company.com">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 계약 항목 -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> 계약 항목</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">유지보수 계약 여부</label>
                    <select class="form-select" name="contract_type" id="contractType">
                        <option value="미계약" {% if customer.contract_type == '미계약' %}selected{% endif %}>미계약</option>
                        <option value="무상" {% if customer.contract_type == '무상' %}selected{% endif %}>무상</option>
                        <option value="유상" {% if customer.contract_type == '유상' %}selected{% endif %}>유상</option>
                        <option value="만료" {% if customer.contract_type == '만료' %}selected{% endif %}>만료</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">계약 시작일</label>
                    <input type="date" class="form-control contract-date" name="contract_start_date" id="contractStartDate"
                           value="{{ customer.contract_start_date.strftime('%Y-%m-%d') if customer.contract_start_date else '' }}">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">계약 종료일</label>
                    <input type="date" class="form-control contract-date" name="contract_end_date" id="contractEndDate"
                           value="{{ customer.contract_end_date.strftime('%Y-%m-%d') if customer.contract_end_date else '' }}">
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">점검 주기</label>
                    <select class="form-select" name="inspection_cycle_type" id="inspectionCycleType">
                        <option value="매월" {% if customer.inspection_cycle_type == '매월' %}selected{% endif %}>매월</option>
                        <option value="분기" {% if customer.inspection_cycle_type == '분기' %}selected{% endif %}>분기</option>
                        <option value="반기" {% if customer.inspection_cycle_type == '반기' %}selected{% endif %}>반기</option>
                        <option value="연1회" {% if customer.inspection_cycle_type == '연1회' %}selected{% endif %}>연1회</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">점검 주기 선택</label>
                    <select class="form-select" name="inspection_cycle_month" id="inspectionCycleMonth">
                        <option value="">선택</option>
                    </select>
                    <div class="form-text" id="cycleHelpText"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 mb-3">
                    <label class="form-label">비고</label>
                    <textarea class="form-control" name="notes" rows="3" placeholder="추가 메모사항을 입력하세요">{{ customer.notes or '' }}</textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- 사내 담당자 -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-people-fill"></i> 사내 담당자</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">담당 엔지니어 (기술팀)</label>
                    <select class="form-select" name="engineer_id">
                        <option value="">선택 안함</option>
                        {% for engineer in engineers %}
                        <option value="{{ engineer.id }}" {% if customer.engineer_id == engineer.id %}selected{% endif %}>
                            {{ engineer.name }} ({{ engineer.username }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">기술팀 소속 사용자만 선택 가능합니다.</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">부담당 엔지니어 (기술팀)</label>
                    <select class="form-select" name="engineer_sub_id">
                        <option value="">선택 안함</option>
                        {% for engineer in engineers %}
                        <option value="{{ engineer.id }}" {% if customer.engineer_sub_id == engineer.id %}selected{% endif %}>
                            {{ engineer.name }} ({{ engineer.username }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">필요 시 부담당을 지정할 수 있습니다.</div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">담당 영업 (영업팀)</label>
                    <select class="form-select" name="sales_id">
                        <option value="">선택 안함</option>
                        {% for sale in sales %}
                        <option value="{{ sale.id }}" {% if customer.sales_id == sale.id %}selected{% endif %}>
                            {{ sale.name }} ({{ sale.username }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">영업팀 소속 사용자만 선택 가능합니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 저장 버튼 -->
    <div class="d-grid gap-2 mb-3">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle"></i> 저장
        </button>
    </div>
</form>

{% if current_user.is_super_admin() or current_user.is_admin() %}
<!-- 고객사 삭제 버튼 (관리자 전용) -->
<div class="d-grid gap-2 mb-4">
    <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal">
        <i class="bi bi-trash"></i> 고객사 삭제
    </button>
</div>

<!-- 고객사 삭제 확인 모달 -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> 고객사 삭제 확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-circle"></i>
                    <strong>경고:</strong> 이 작업은 되돌릴 수 없습니다!
                </div>
                <p>정말로 이 고객사를 삭제하시겠습니까?</p>
                <p>삭제하려면 고객사 이름 <strong class="text-danger">"{{ customer.name }}"</strong>을(를) 아래에 정확히 입력하세요.</p>

                <form method="POST" action="{{ url_for('delete_customer', customer_id=customer.id) }}" id="deleteCustomerForm">
                    <div class="mb-3">
                        <label class="form-label">고객사 이름 확인</label>
                        <input type="text" class="form-control" name="confirm_name" id="confirmNameInput" required placeholder="{{ customer.name }}">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                            <i class="bi bi-trash"></i> 삭제 확인
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> 취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// 부담당자 관리 변수
let subContactCount = 0;
const maxSubContacts = 3;

// 페이지 로드 시 기존 부담당자 데이터 확인 및 표시
window.addEventListener('load', function() {
    // 기존 데이터가 있으면 해당 부담당자 섹션 표시
    {% if customer.contact_name_sub1 %}
        showSubContact(1);
    {% endif %}
    {% if customer.contact_name_sub2 %}
        showSubContact(2);
    {% endif %}
    {% if customer.contact_name_sub3 %}
        showSubContact(3);
    {% endif %}

    // 계약 유형 초기화
    const contractType = document.getElementById('contractType').value;
    const contractDates = document.querySelectorAll('.contract-date');
    const isActive = contractType === '무상' || contractType === '유상';

    contractDates.forEach(date => {
        date.disabled = !isActive;
    });

    // 점검 주기 초기화
    updateInspectionCycleOptions();
    
    // 버튼 상태 업데이트
    updateAddButton();
});

// 부담당자 추가 버튼 클릭
document.getElementById('addSubContactBtn').addEventListener('click', function() {
    if (subContactCount < maxSubContacts) {
        const nextIndex = findNextAvailableIndex();
        if (nextIndex > 0) {
            showSubContact(nextIndex);
            updateAddButton();
        }
    }
});

// 다음 사용 가능한 인덱스 찾기
function findNextAvailableIndex() {
    for (let i = 1; i <= maxSubContacts; i++) {
        const section = document.getElementById('subContact' + i);
        if (section.style.display === 'none') {
            return i;
        }
    }
    return -1;
}

// 부담당자 섹션 표시
function showSubContact(index) {
    const section = document.getElementById('subContact' + index);
    if (section && section.style.display === 'none') {
        section.style.display = 'block';
        subContactCount++;
        updateAddButton();
    }
}

// 부담당자 제거
function removeSubContact(index) {
    const section = document.getElementById('subContact' + index);
    if (section) {
        // 입력 필드 초기화
        const inputs = section.querySelectorAll('input');
        inputs.forEach(input => input.value = '');
        
        section.style.display = 'none';
        subContactCount--;
        updateAddButton();
    }
}

// 추가 버튼 상태 업데이트
function updateAddButton() {
    const addBtn = document.getElementById('addSubContactBtn');
    const btnContainer = document.getElementById('addSubContactBtnContainer');
    
    if (subContactCount >= maxSubContacts) {
        btnContainer.style.display = 'none';
    } else {
        btnContainer.style.display = 'block';
        addBtn.innerHTML = '<i class="bi bi-plus-circle"></i> 부 담당자 추가 (' + subContactCount + '/' + maxSubContacts + ')';
    }
}

{% if current_user.is_super_admin() or current_user.is_admin() %}
// 고객사 삭제 - 이름 확인 후 삭제 버튼 활성화
document.getElementById('confirmNameInput').addEventListener('input', function() {
    const customerName = "{{ customer.name }}";
    const inputValue = this.value;
    const deleteBtn = document.getElementById('confirmDeleteBtn');

    if (inputValue === customerName) {
        deleteBtn.disabled = false;
    } else {
        deleteBtn.disabled = true;
    }
});

// 모달이 닫힐 때 입력 필드 초기화
document.getElementById('deleteCustomerModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('confirmNameInput').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
});
{% endif %}

// 계약 유형에 따라 날짜 필드 활성화/비활성화
document.getElementById('contractType').addEventListener('change', function() {
    const contractDates = document.querySelectorAll('.contract-date');
    const isActive = this.value === '무상' || this.value === '유상';

    contractDates.forEach(date => {
        date.disabled = !isActive;
        if (!isActive) {
            date.value = '';
        }
    });
});

// 점검 주기 유형에 따라 선택 옵션 업데이트
document.getElementById('inspectionCycleType').addEventListener('change', updateInspectionCycleOptions);

function updateInspectionCycleOptions() {
    const cycleType = document.getElementById('inspectionCycleType').value;
    const cycleMonth = document.getElementById('inspectionCycleMonth');
    const helpText = document.getElementById('cycleHelpText');

    cycleMonth.innerHTML = '<option value="">선택</option>';

    if (cycleType === '매월') {
        cycleMonth.disabled = true;
        helpText.textContent = '매월 점검이 필요합니다.';
    } else if (cycleType === '분기') {
        cycleMonth.disabled = false;
        cycleMonth.innerHTML = `
            <option value="">선택</option>
            <option value="1" {{ 'selected' if customer.inspection_cycle_month == 1 else '' }}>1분기 (1, 4, 7, 10월)</option>
            <option value="2" {{ 'selected' if customer.inspection_cycle_month == 2 else '' }}>2분기 (2, 5, 8, 11월)</option>
            <option value="3" {{ 'selected' if customer.inspection_cycle_month == 3 else '' }}>3분기 (3, 6, 9, 12월)</option>
        `;
        helpText.textContent = '점검이 필요한 분기를 선택하세요.';
    } else if (cycleType === '반기') {
        cycleMonth.disabled = false;
        cycleMonth.innerHTML = `
            <option value="">선택</option>
            <option value="1" {{ 'selected' if customer.inspection_cycle_month == 1 else '' }}>1월, 7월</option>
            <option value="2" {{ 'selected' if customer.inspection_cycle_month == 2 else '' }}>2월, 8월</option>
            <option value="3" {{ 'selected' if customer.inspection_cycle_month == 3 else '' }}>3월, 9월</option>
            <option value="4" {{ 'selected' if customer.inspection_cycle_month == 4 else '' }}>4월, 10월</option>
            <option value="5" {{ 'selected' if customer.inspection_cycle_month == 5 else '' }}>5월, 11월</option>
            <option value="6" {{ 'selected' if customer.inspection_cycle_month == 6 else '' }}>6월, 12월</option>
        `;
        helpText.textContent = '점검이 필요한 월을 선택하세요 (연 2회).';
    } else if (cycleType === '연1회') {
        cycleMonth.disabled = false;
        for (let i = 1; i <= 12; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i + '월';
            if ({{ customer.inspection_cycle_month or 0 }} === i) {
                option.selected = true;
            }
            cycleMonth.appendChild(option);
        }
        helpText.textContent = '점검이 필요한 월을 선택하세요 (연 1회).';
    }
}
</script>
{% endblock %}
