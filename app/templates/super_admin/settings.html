{% extends "base.html" %}

{% block title %}시스템 설정{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-gear"></i> 시스템 설정</h2>
        <p class="text-muted">웹 사이트 전체 설정을 관리합니다.</p>
    </div>
</div>

<form method="POST" action="{{ url_for('system_settings') }}">
    <!-- 설정 요약 (전체 너비) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> 현재 설정 요약</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">기본 패스워드</dt>
                            <dd class="mb-0"><code>{{ settings.default_password }}</code></dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">패스워드 길이</dt>
                            <dd class="mb-0">{{ settings.password_min_length }}-{{ settings.password_max_length }}자</dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">대문자 필수</dt>
                            <dd class="mb-0">
                                {% if settings.password_require_uppercase %}
                                <span class="badge bg-success">Yes</span>
                                {% else %}
                                <span class="badge bg-secondary">No</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">중복 로그인 방지</dt>
                            <dd class="mb-0">
                                {% if settings.prevent_duplicate_login %}
                                <span class="badge bg-warning">활성화</span>
                                {% else %}
                                <span class="badge bg-secondary">비활성화</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">세션 타임아웃</dt>
                            <dd class="mb-0">
                                {% if settings.session_timeout_enabled %}
                                <span class="badge bg-info">{{ settings.session_timeout_minutes }}분</span>
                                {% else %}
                                <span class="badge bg-secondary">비활성화</span>
                                {% endif %}
                            </dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">로그인 실패 제한</dt>
                            <dd class="mb-0"><span class="badge bg-danger">{{ settings.login_failure_limit }}회</span></dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">계정 잠금 시간</dt>
                            <dd class="mb-0"><span class="badge bg-warning text-dark">{{ settings.account_lock_minutes }}분</span></dd>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <dt class="text-muted small">패스워드 변경 주기</dt>
                            <dd class="mb-0">
                                {% if settings.password_expiry_enabled %}
                                <span class="badge bg-danger">{{ settings.password_expiry_days }}일</span>
                                {% else %}
                                <span class="badge bg-secondary">비활성화</span>
                                {% endif %}
                            </dd>
                        </div>
                    </div>
                    {% if settings.updated_at %}
                    <hr class="mt-2 mb-2">
                    <p class="text-muted small mb-0">
                        <i class="bi bi-clock"></i> 마지막 업데이트: {{ settings.updated_at.strftime('%Y-%m-%d %H:%M') }}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 기본 패스워드 설정 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-key-fill"></i> 기본 패스워드 설정</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">기본 패스워드</label>
                        <input type="text" class="form-control" name="default_password"
                               value="{{ settings.default_password }}" required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 신규 계정 생성 시 또는 패스워드 초기화 시 사용되는 기본 패스워드입니다.
                            <br>기본 패스워드는 복잡성 규칙을 따르지 않습니다.
                        </div>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>주의:</strong> 사용자는 최초 로그인 후 반드시 패스워드를 변경해야 합니다.
                    </div>
                </div>
            </div>
        </div>

        <!-- 패스워드 복잡성 설정 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> 패스워드 복잡성 설정</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">최소 자릿수 (8-20자)</label>
                        <input type="number" class="form-control" name="password_min_length"
                               value="{{ settings.password_min_length }}" min="8" max="20" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">최대 자릿수 (8-20자)</label>
                        <input type="number" class="form-control" name="password_max_length"
                               value="{{ settings.password_max_length }}" min="8" max="20" required>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="password_require_uppercase"
                               id="password_require_uppercase"
                               {% if settings.password_require_uppercase %}checked{% endif %}>
                        <label class="form-check-label" for="password_require_uppercase">
                            대문자 필수
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" name="password_require_special"
                               id="password_require_special"
                               {% if settings.password_require_special %}checked{% endif %}>
                        <label class="form-check-label" for="password_require_special">
                            특수문자 필수
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="password_require_number"
                               id="password_require_number"
                               {% if settings.password_require_number %}checked{% endif %}>
                        <label class="form-check-label" for="password_require_number">
                            숫자 필수
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 로그인 보안 설정 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> 로그인 보안 설정</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="prevent_duplicate_login"
                               id="prevent_duplicate_login"
                               {% if settings.prevent_duplicate_login %}checked{% endif %}>
                        <label class="form-check-label" for="prevent_duplicate_login">
                            중복 로그인 방지
                        </label>
                        <div class="form-text">
                            활성화 시 다른 세션에서 로그인 시도 시 기존 세션이 로그아웃됩니다.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">패스워드 오류 허용 횟수 (1-5회)</label>
                        <input type="number" class="form-control" name="login_failure_limit"
                               value="{{ settings.login_failure_limit }}" min="1" max="5" required>
                        <div class="form-text">
                            설정한 횟수 초과 시 계정이 잠깁니다.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">계정 잠금 시간 (5-30분)</label>
                        <input type="number" class="form-control" name="account_lock_minutes"
                               value="{{ settings.account_lock_minutes }}" min="5" max="30" required>
                        <div class="form-text">
                            로그인 실패 횟수 초과 시 계정이 잠기는 시간입니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 세션 타임아웃 설정 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> 세션 타임아웃 설정</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="session_timeout_enabled"
                               id="session_timeout_enabled"
                               {% if settings.session_timeout_enabled %}checked{% endif %}
                               onchange="toggleSessionTimeout()">
                        <label class="form-check-label" for="session_timeout_enabled">
                            세션 타임아웃 활성화
                        </label>
                        <div class="form-text">
                            일정 시간 동안 활동이 없으면 자동으로 로그아웃됩니다.
                        </div>
                    </div>

                    <div class="mb-3" id="session_timeout_settings">
                        <label class="form-label">타임아웃 시간 (3-60분)</label>
                        <input type="number" class="form-control" name="session_timeout_minutes"
                               value="{{ settings.session_timeout_minutes }}" min="3" max="60" required>
                        <div class="form-text">
                            비활동 상태가 이 시간을 초과하면 자동 로그아웃됩니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 패스워드 변경 주기 설정 -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-x"></i> 패스워드 변경 주기 설정</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" name="password_expiry_enabled"
                               id="password_expiry_enabled"
                               {% if settings.password_expiry_enabled %}checked{% endif %}
                               onchange="togglePasswordExpiry()">
                        <label class="form-check-label" for="password_expiry_enabled">
                            패스워드 변경 주기 활성화
                        </label>
                        <div class="form-text">
                            활성화 시 지정된 일자 후 패스워드 변경이 필요합니다.
                        </div>
                    </div>

                    <div class="mb-3" id="password_expiry_settings">
                        <label class="form-label">변경 주기 (30-365일)</label>
                        <input type="number" class="form-control" name="password_expiry_days"
                               value="{{ settings.password_expiry_days }}" min="30" max="365" required>
                        <div class="form-text">
                            마지막 변경 후 이 기간이 지나면 패스워드 변경이 필요합니다.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-circle"></i> 설정 저장
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> 취소
            </a>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
function toggleSessionTimeout() {
    var enabled = document.getElementById('session_timeout_enabled').checked;
    var settings = document.getElementById('session_timeout_settings');
    if (enabled) {
        settings.style.display = 'block';
    } else {
        settings.style.display = 'none';
    }
}

function togglePasswordExpiry() {
    var enabled = document.getElementById('password_expiry_enabled').checked;
    var settings = document.getElementById('password_expiry_settings');
    if (enabled) {
        settings.style.display = 'block';
    } else {
        settings.style.display = 'none';
    }
}

// 페이지 로드 시 초기 상태 설정
document.addEventListener('DOMContentLoaded', function() {
    toggleSessionTimeout();
    togglePasswordExpiry();
});
</script>
{% endblock %}
