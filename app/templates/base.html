<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}고객사 관리 시스템{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    {% block extra_css %}{% endblock %}
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% if current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-building"></i> 고객사 관리 시스템
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if current_user.is_super_admin() %}
                    <!-- 슈퍼 관리자 메뉴 -->
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-speedometer2"></i> 대시보드
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownAccounts" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-gear"></i> 계정 관리
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownAccounts">
                            <li><a class="dropdown-item" href="{{ url_for('manage_superadmins') }}">
                                <i class="bi bi-shield-fill-check"></i> 슈퍼관리자 관리
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_admins') }}">
                                <i class="bi bi-person-badge"></i> 관리자 관리
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('manage_users_unified') }}">
                                <i class="bi bi-people"></i> 사용자 관리
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('manage_customers') }}">
                            <i class="bi bi-building"></i> 고객사 관리
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownLogs" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-text"></i> 서비스 로그
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownLogs">
                            <li><a class="dropdown-item" href="{{ url_for('login_logs') }}">
                                <i class="bi bi-box-arrow-in-right"></i> 로그인 이력
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('upload_logs') }}">
                                <i class="bi bi-cloud-upload"></i> 업로드 이력
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('system_logs') }}">
                                <i class="bi bi-gear"></i> 시스템 이력
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('system_settings') }}">
                            <i class="bi bi-gear"></i> 시스템 설정
                        </a>
                    </li>

                    {% elif current_user.is_admin() %}
                    <!-- 일반 관리자 메뉴 -->
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-speedometer2"></i> 대시보드
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('manage_users_unified') }}">
                            <i class="bi bi-people"></i> 사용자 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('manage_customers') }}">
                            <i class="bi bi-building"></i> 고객사 관리
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownLogsAdmin" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-text"></i> 서비스 로그
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownLogsAdmin">
                            <li><a class="dropdown-item" href="{{ url_for('login_logs') }}">
                                <i class="bi bi-box-arrow-in-right"></i> 로그인 이력
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('upload_logs') }}">
                                <i class="bi bi-cloud-upload"></i> 업로드 이력
                            </a></li>
                        </ul>
                    </li>

                    {% else %}
                    <!-- 일반 사용자 메뉴 -->
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-speedometer2"></i> 대시보드
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('manage_customers') }}">
                            <i class="bi bi-building"></i> 고객사 관리
                        </a>
                    </li>
                    {% if current_user.department == '기술팀' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upload_document') }}">
                            <i class="bi bi-cloud-upload"></i> 점검서 업로드
                        </a>
                    </li>
                    {% endif %}
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> {{ current_user.username }}
                            {% if current_user.is_super_admin() %}
                            <span class="badge bg-danger ms-1">슈퍼관리자</span>
                            {% elif current_user.is_admin() %}
                            <span class="badge bg-primary ms-1">관리자</span>
                            {% else %}
                            <span class="badge bg-success ms-1">사용자</span>
                            {% endif %}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                    <i class="bi bi-key"></i> 패스워드 변경
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="{{ url_for('logout') }}">
                                    <i class="bi bi-box-arrow-right"></i> 로그아웃
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    {% endif %}

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- 패스워드 변경 모달 -->
    {% if current_user.is_authenticated %}
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="bi bi-key"></i> 패스워드 변경
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="current_password" class="form-label">현재 패스워드 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="current_password" name="current_password" required>
                        </div>

                        <div class="mb-3">
                            <label for="new_password" class="form-label">새 패스워드 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="new_password" name="new_password" required>
                            <div class="form-text" id="password_requirements">
                                <i class="bi bi-info-circle"></i> 패스워드 요구사항을 불러오는 중...
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirm_password" class="form-label">새 패스워드 확인 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                        </div>

                        <div id="passwordChangeAlert" class="alert d-none" role="alert"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> 취소
                    </button>
                    <button type="button" class="btn btn-primary" id="submitPasswordChange">
                        <i class="bi bi-check-circle"></i> 패스워드 변경
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% if current_user.is_authenticated %}
    <script>
    // 패스워드 변경 모달이 열릴 때 패스워드 요구사항 로드
    document.getElementById('changePasswordModal').addEventListener('show.bs.modal', function () {
        // 폼 초기화
        document.getElementById('changePasswordForm').reset();
        document.getElementById('passwordChangeAlert').classList.add('d-none');

        // 패스워드 요구사항 로드
        fetch('/api/password-requirements')
            .then(response => response.json())
            .then(data => {
                let requirementsHtml = '<i class="bi bi-info-circle"></i> 패스워드 요구사항:<ul class="mb-0 mt-1">';
                requirementsHtml += '<li>길이: ' + data.min_length + '-' + data.max_length + '자</li>';
                if (data.require_uppercase) {
                    requirementsHtml += '<li>대문자 포함 필수</li>';
                }
                if (data.require_special) {
                    requirementsHtml += '<li>특수문자 포함 필수</li>';
                }
                if (data.require_number) {
                    requirementsHtml += '<li>숫자 포함 필수</li>';
                }
                requirementsHtml += '</ul>';
                document.getElementById('password_requirements').innerHTML = requirementsHtml;
            });
    });

    // 패스워드 일치 확인
    document.getElementById('confirm_password').addEventListener('input', function() {
        var newPassword = document.getElementById('new_password').value;
        var confirmPassword = this.value;

        if (confirmPassword && newPassword !== confirmPassword) {
            this.setCustomValidity('패스워드가 일치하지 않습니다.');
        } else {
            this.setCustomValidity('');
        }
    });

    // 새 패스워드 입력 시에도 확인
    document.getElementById('new_password').addEventListener('input', function() {
        var confirmPasswordField = document.getElementById('confirm_password');
        if (confirmPasswordField.value) {
            confirmPasswordField.dispatchEvent(new Event('input'));
        }
    });

    // 패스워드 변경 제출
    document.getElementById('submitPasswordChange').addEventListener('click', function() {
        var form = document.getElementById('changePasswordForm');

        // 폼 유효성 검사
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        var formData = new FormData(form);
        var alertDiv = document.getElementById('passwordChangeAlert');

        // 제출 버튼 비활성화
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 변경 중...';

        fetch('/api/change-password', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 성공 메시지 표시
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = data.message;
                alertDiv.classList.remove('d-none');

                // 2초 후 로그아웃하고 로그인 페이지로 리다이렉트
                setTimeout(function() {
                    window.location.href = '/logout?password_changed=true';
                }, 2000);
            } else {
                // 에러 메시지 표시
                alertDiv.className = 'alert alert-danger';
                alertDiv.textContent = data.message;
                alertDiv.classList.remove('d-none');

                // 제출 버튼 다시 활성화
                document.getElementById('submitPasswordChange').disabled = false;
                document.getElementById('submitPasswordChange').innerHTML = '<i class="bi bi-check-circle"></i> 패스워드 변경';
            }
        })
        .catch(error => {
            alertDiv.className = 'alert alert-danger';
            alertDiv.textContent = '패스워드 변경 중 오류가 발생했습니다.';
            alertDiv.classList.remove('d-none');

            // 제출 버튼 다시 활성화
            document.getElementById('submitPasswordChange').disabled = false;
            document.getElementById('submitPasswordChange').innerHTML = '<i class="bi bi-check-circle"></i> 패스워드 변경';
        });
    });
    </script>
    {% endif %}

    <script>
    // 플래시 메시지 자동 사라짐 (2초 후)
    document.addEventListener('DOMContentLoaded', function() {
        var alerts = document.querySelectorAll('.alert-dismissible');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 2000);
        });
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
