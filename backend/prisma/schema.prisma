// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 사용자 모델
model User {
  id                    Int       @id @default(autoincrement())
  username              String    @unique @db.VarChar(80)
  name                  String    @db.VarChar(100)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  email                 String?   @unique @db.VarChar(120)
  role                  String    @default("user") @db.VarChar(20) // super_admin, admin, user
  department            String?   @db.VarChar(20) // 기술팀, 영업팀, 개발팀 (user role only)
  description           String?   @db.VarChar(200)
  isActive              Boolean   @default(true) @map("is_active")
  customerId            Int?      @map("customer_id")

  // 계정 잠금
  isLocked              Boolean   @default(false) @map("is_locked")
  lockedUntil           DateTime? @map("locked_until")
  failedLoginAttempts   Int       @default(0) @map("failed_login_attempts")

  // 최초 로그인
  isFirstLogin          Boolean   @default(true) @map("is_first_login")

  // 타임스탬프
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  passwordChangedAt     DateTime  @default(now()) @map("password_changed_at")
  lastLogin             DateTime? @map("last_login")

  // Relations
  assignedCustomers     UserCustomer[]
  uploadedDocuments     Document[]
  serviceLogs           ServiceLog[]
  loginAttempts         LoginAttempt[]
  userSessions          UserSession[]
  customersAsEngineer   Customer[] @relation("Engineer")
  customersAsEngineerSub Customer[] @relation("EngineerSub")
  customersAsSales      Customer[] @relation("Sales")
  updatedSettings       SystemSettings[]
  createdSupportLogs    SupportLog[] @relation("SupportLogCreator")
  createdNotices        Notice[] @relation("NoticeCreator")

  @@map("users")
}

// 고객사 모델
model Customer {
  id                      Int       @id @default(autoincrement())
  name                    String    @unique @db.VarChar(200)
  location                String?   @db.VarChar(200)

  // 정 담당자
  contactName             String?   @map("contact_name") @db.VarChar(100)
  contactPosition         String?   @map("contact_position") @db.VarChar(100)
  contactDepartment       String?   @map("contact_department") @db.VarChar(100)
  contactMobile           String?   @map("contact_mobile") @db.VarChar(50)
  contactPhone            String?   @map("contact_phone") @db.VarChar(50)
  contactEmail            String?   @map("contact_email") @db.VarChar(120)

  // 부담당자 1
  contactNameSub1         String?   @map("contact_name_sub1") @db.VarChar(100)
  contactPositionSub1     String?   @map("contact_position_sub1") @db.VarChar(100)
  contactDepartmentSub1   String?   @map("contact_department_sub1") @db.VarChar(100)
  contactMobileSub1       String?   @map("contact_mobile_sub1") @db.VarChar(50)
  contactPhoneSub1        String?   @map("contact_phone_sub1") @db.VarChar(50)
  contactEmailSub1        String?   @map("contact_email_sub1") @db.VarChar(120)

  // 부담당자 2
  contactNameSub2         String?   @map("contact_name_sub2") @db.VarChar(100)
  contactPositionSub2     String?   @map("contact_position_sub2") @db.VarChar(100)
  contactDepartmentSub2   String?   @map("contact_department_sub2") @db.VarChar(100)
  contactMobileSub2       String?   @map("contact_mobile_sub2") @db.VarChar(50)
  contactPhoneSub2        String?   @map("contact_phone_sub2") @db.VarChar(50)
  contactEmailSub2        String?   @map("contact_email_sub2") @db.VarChar(120)

  // 부담당자 3
  contactNameSub3         String?   @map("contact_name_sub3") @db.VarChar(100)
  contactPositionSub3     String?   @map("contact_position_sub3") @db.VarChar(100)
  contactDepartmentSub3   String?   @map("contact_department_sub3") @db.VarChar(100)
  contactMobileSub3       String?   @map("contact_mobile_sub3") @db.VarChar(50)
  contactPhoneSub3        String?   @map("contact_phone_sub3") @db.VarChar(50)
  contactEmailSub3        String?   @map("contact_email_sub3") @db.VarChar(120)

  // 계약 정보
  contractType            String    @default("미계약") @map("contract_type") @db.VarChar(20)
  contractStartDate       DateTime? @map("contract_start_date") @db.Date
  contractEndDate         DateTime? @map("contract_end_date") @db.Date
  hardwareIncluded        Boolean   @default(true) @map("hardware_included")

  // 점검 정보
  inspectionCycleType     String    @default("매월") @map("inspection_cycle_type") @db.VarChar(20)
  inspectionCycleMonth    Int?      @map("inspection_cycle_month")
  lastInspectionDate      DateTime? @map("last_inspection_date") @db.Date

  // 비고
  notes                   String?   @db.Text

  // 사내 담당자
  engineerId              Int?      @map("engineer_id")
  engineerSubId           Int?      @map("engineer_sub_id")
  salesId                 Int?      @map("sales_id")

  // 타임스탬프
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  // Relations
  engineer                User?     @relation("Engineer", fields: [engineerId], references: [id])
  engineerSub             User?     @relation("EngineerSub", fields: [engineerSubId], references: [id])
  sales                   User?     @relation("Sales", fields: [salesId], references: [id])
  assignedUsers           UserCustomer[]
  documents               Document[]
  inspectionTargets       InspectionTarget[]
  sourceManagement        SourceManagement?
  supportLogs             SupportLog[]

  @@map("customers")
}

// 사용자-고객사 중간 테이블
model UserCustomer {
  userId       Int      @map("user_id")
  customerId   Int      @map("customer_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@id([userId, customerId])
  @@map("user_customers")
}

// 점검 대상 항목
model InspectionTarget {
  id           Int       @id @default(autoincrement())
  customerId   Int       @map("customer_id")
  targetType   String    @map("target_type") @db.VarChar(50)
  customName   String?   @map("custom_name") @db.VarChar(100)
  productName  String?   @map("product_name") @db.VarChar(100)
  displayOrder Int       @default(0) @map("display_order")
  templatePath String?   @map("template_path") @db.VarChar(500)
  createdAt    DateTime  @default(now()) @map("created_at")

  customer     Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  documents    Document[]

  @@map("inspection_targets")
}

// 점검 문서
model Document {
  id                  Int       @id @default(autoincrement())
  customerId          Int       @map("customer_id")
  inspectionTargetId  Int?      @map("inspection_target_id")
  title               String    @db.VarChar(200)
  description         String?   @db.Text
  filename            String    @db.VarChar(255)
  filepath            String    @db.VarChar(500)
  fileSize            Int?      @map("file_size")
  uploadedBy          Int       @map("uploaded_by")
  uploadedAt          DateTime  @default(now()) @map("uploaded_at")
  inspectionDate      DateTime? @map("inspection_date") @db.Date
  inspectionType      String?   @map("inspection_type") @db.VarChar(20)

  customer            Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  inspectionTarget    InspectionTarget? @relation(fields: [inspectionTargetId], references: [id], onDelete: SetNull)
  uploader            User      @relation(fields: [uploadedBy], references: [id])

  @@map("documents")
}

// 시스템 설정
model SystemSettings {
  id                          Int       @id @default(autoincrement())

  // 초기 패스워드
  defaultPassword             String    @default("1111") @map("default_password") @db.VarChar(50)

  // 비밀번호 복잡성
  passwordMinLength           Int       @default(8) @map("password_min_length")
  passwordRequireUppercase    Boolean   @default(true) @map("password_require_uppercase")
  passwordRequireSpecial      Boolean   @default(true) @map("password_require_special")
  passwordRequireNumber       Boolean   @default(true) @map("password_require_number")

  // 비밀번호 변경 주기
  passwordExpiryEnabled       Boolean   @default(false) @map("password_expiry_enabled")
  passwordExpiryDays          Int       @default(90) @map("password_expiry_days")

  // 중복 로그인 방지
  preventDuplicateLogin       Boolean   @default(false) @map("prevent_duplicate_login")

  // 로그인 실패 횟수
  loginFailureLimitEnabled    Boolean   @default(false) @map("login_failure_limit_enabled")
  loginFailureLimit           Int       @default(5) @map("login_failure_limit")
  accountLockMinutes          Int       @default(10) @map("account_lock_minutes")

  updatedAt                   DateTime  @updatedAt @map("updated_at")
  updatedBy                   Int?      @map("updated_by")

  updater                     User?     @relation(fields: [updatedBy], references: [id])

  @@map("system_settings")
}

// 로그인 시도 기록
model LoginAttempt {
  id          Int       @id @default(autoincrement())
  userId      Int       @map("user_id")
  attemptTime DateTime  @default(now()) @map("attempt_time")
  success     Boolean   @default(false)
  ipAddress   String?   @map("ip_address") @db.VarChar(45)

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_attempts")
}

// 사용자 세션
model UserSession {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  sessionId    String    @unique @map("session_id") @db.VarChar(255)
  loginTime    DateTime  @default(now()) @map("login_time")
  lastActivity DateTime  @default(now()) @map("last_activity")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// 서비스 로그
model ServiceLog {
  id          Int       @id @default(autoincrement())
  userId      Int?      @map("user_id")
  logType     String    @map("log_type") @db.VarChar(20) // 정상, 경고, 오류, 정보
  action      String    @db.VarChar(100)
  description String?   @db.Text
  beforeValue String?   @map("before_value") @db.Text
  afterValue  String?   @map("after_value") @db.Text
  ipAddress   String?   @map("ip_address") @db.VarChar(45)
  createdAt   DateTime  @default(now()) @map("created_at")

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("service_logs")
}

// 소스 관리
model SourceManagement {
  id                    Int      @id @default(autoincrement())
  customerId            Int      @unique @map("customer_id")

  // 클라이언트 정보
  clientVersion         String?  @map("client_version") @db.VarChar(100)
  clientCustomInfo      String?  @map("client_custom_info") @db.Text

  // 가상PC 정보
  virtualPcOsVersion    String?  @map("virtual_pc_os_version") @db.VarChar(50)
  virtualPcBuildVersion String?  @map("virtual_pc_build_version") @db.VarChar(100)
  virtualPcGuestAddition String? @map("virtual_pc_guest_addition") @db.VarChar(100)
  virtualPcImageInfo    String?  @map("virtual_pc_image_info") @db.Text

  // 관리웹 정보
  adminWebReleaseDate   String?  @map("admin_web_release_date") @db.VarChar(20)
  adminWebCustomInfo    String?  @map("admin_web_custom_info") @db.Text

  // 서버 구성 (이중화 타입만 유지)
  redundancyType        String   @default("단일 구성") @map("redundancy_type") @db.VarChar(20)

  // 인사연동
  hrIntegrationEnabled  Boolean  @default(false) @map("hr_integration_enabled")
  hrDbType              String?  @map("hr_db_type") @db.VarChar(50)
  hrDbVersion           String?  @map("hr_db_version") @db.VarChar(50)

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  customer              Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  servers               ServerInfo[]

  @@map("source_management")
}

// 서버 정보
model ServerInfo {
  id                    Int      @id @default(autoincrement())
  sourceManagementId    Int      @map("source_management_id")

  // 서버 기본 정보
  serverType            String   @map("server_type") @db.VarChar(50) // 관리서버, 보안게이트웨이서버, 통합서버
  manufacturer          String?  @db.VarChar(100)      // 제조사
  modelName             String?  @map("model_name") @db.VarChar(100) // 모델명
  hostname              String?  @db.VarChar(100)      // 호스트네임

  // OS 정보
  osType                String?  @map("os_type") @db.VarChar(50)     // OS 종류 (예: CentOS, Ubuntu, Windows Server)
  osVersion             String?  @map("os_version") @db.VarChar(50)  // OS 버전 (예: 7.9, 20.04)

  // 하드웨어 정보
  cpuType               String?  @map("cpu_type") @db.VarChar(100)   // CPU 종류
  memoryCapacity        String?  @map("memory_capacity") @db.VarChar(50) // 메모리 용량 (예: 32GB)
  diskCapacity          String?  @map("disk_capacity") @db.VarChar(50)   // 디스크 용량 (예: 500GB)

  // 네트워크 정보
  nicFiberCount         Int      @default(0) @map("nic_fiber_count")     // Fiber NIC 수량
  nicUtpCount           Int      @default(0) @map("nic_utp_count")       // UTP NIC 수량

  // 전원 정보
  powerSupplyCount      Int      @default(0) @map("power_supply_count")  // 전원 수량

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  sourceManagement      SourceManagement @relation(fields: [sourceManagementId], references: [id], onDelete: Cascade)

  @@map("server_info")
}

// 고객사 지원 로그
model SupportLog {
  id              Int       @id @default(autoincrement())
  customerId      Int       @map("customer_id")
  supportDate     DateTime  @map("support_date") @db.Date
  inquirer        String?   @db.VarChar(100)       // 문의자
  target          String?   @db.VarChar(200)       // 대상
  category        String?   @db.VarChar(100)       // 구분
  userInfo        String?   @map("user_info") @db.VarChar(200)  // 사용자 정보
  actionStatus    String?   @map("action_status") @db.VarChar(50) // 조치 여부
  inquiryContent  String?   @map("inquiry_content") @db.Text    // 문의 내용
  actionContent   String?   @map("action_content") @db.Text     // 조치 내용
  remarks         String?   @db.Text               // 비고
  createdBy       Int?      @map("created_by")     // 작성자 (지원 엔지니어)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  creator         User?     @relation("SupportLogCreator", fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("support_logs")
}

// 공지사항
model Notice {
  id          Int       @id @default(autoincrement())
  title       String    @db.VarChar(200)
  content     String    @db.Text
  createdBy   Int       @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  creator     User      @relation("NoticeCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("notices")
}

