name: Docker Build and Push

# 이 워크플로우는 다음 경우에 실행됩니다:
# 1. main 브랜치에 push될 때
# 2. v로 시작하는 태그가 push될 때 (예: v1.0.0)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:  # 수동 실행 허용

env:
  # Docker Hub 이미지 이름
  BACKEND_IMAGE_NAME: igor0670/customer-storage-backend
  FRONTEND_IMAGE_NAME: igor0670/customer-storage-frontend

jobs:
  build-and-push-backend:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Docker Buildx 설정 (멀티 플랫폼 빌드 지원)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. 메타데이터 추출 (태그 및 레이블)
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            # main 브랜치 푸시 시 latest 태그
            type=raw,value=latest,enable={{is_default_branch}}
            # 태그 푸시 시 버전 태그 (예: v2.1.2 -> 2.1.2)
            type=semver,pattern={{version}}

      # 5. Backend Docker 이미지 빌드 및 푸시
      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # AMD64 플랫폼만 지원 (ARM64는 QEMU 이슈로 제외)
          platforms: linux/amd64
          # 빌드 캐시 사용으로 빌드 시간 단축
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_IMAGE_NAME }}:buildcache,mode=max

      # 6. 빌드 결과 출력
      - name: Backend image digest
        run: echo "${{ steps.meta.outputs.tags }}"

  build-and-push-frontend:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Docker Buildx 설정 (멀티 플랫폼 빌드 지원)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Docker Hub 로그인
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. 메타데이터 추출 (태그 및 레이블)
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            # main 브랜치 푸시 시 latest 태그
            type=raw,value=latest,enable={{is_default_branch}}
            # 태그 푸시 시 버전 태그 (예: v2.1.2 -> 2.1.2)
            type=semver,pattern={{version}}

      # 5. Frontend Docker 이미지 빌드 및 푸시
      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # AMD64 플랫폼만 지원 (ARM64는 QEMU 이슈로 제외)
          platforms: linux/amd64
          # 빌드 캐시 사용으로 빌드 시간 단축
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_IMAGE_NAME }}:buildcache,mode=max

      # 6. 빌드 결과 출력
      - name: Frontend image digest
        run: echo "${{ steps.meta.outputs.tags }}"

  # GitHub Release 생성 (태그 푸시 시에만)
  create-release:
    needs: [build-and-push-backend, build-and-push-frontend]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Docker Images

            Backend: `docker pull igor0670/customer-storage-backend:${{ steps.version.outputs.VERSION }}`
            Frontend: `docker pull igor0670/customer-storage-frontend:${{ steps.version.outputs.VERSION }}`

            ## 배포 방법

            ```bash
            # .env 파일에 버전 설정
            VERSION=${{ steps.version.outputs.VERSION }}

            # Docker Compose로 배포
            docker compose pull
            docker compose up -d
            ```

            ## 변경 사항
            자세한 내용은 아래 자동 생성된 릴리즈 노트를 참고하세요.

      # 7. 슬랙 알림 (선택사항, SLACK_WEBHOOK_URL 시크릿 설정 필요)
      # - name: Slack Notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Docker image build ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
